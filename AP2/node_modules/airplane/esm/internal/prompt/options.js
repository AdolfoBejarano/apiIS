import { dedent } from "ts-dedent";
import { makeSlug } from "./slug";
import { serializeParamValue, serializeParamValueSingle, } from "../params/params_serialized";
const isLabeledOption = (v) => {
    return typeof v === "object" && Object.prototype.hasOwnProperty.call(v, "value");
};
export const optionsToSchema = (name, type, opts) => {
    var _a, _b;
    const options = (_a = opts.options) === null || _a === void 0 ? void 0 : _a.map((opt) => {
        if (isLabeledOption(opt)) {
            return { ...opt, value: serializeParamValueSingle(opt.value) };
        }
        return serializeParamValueSingle(opt);
    });
    const types = {
        boolean: "boolean",
        upload: "upload",
        date: "date",
        datetime: "datetime",
        configvar: "configvar",
        float: "float",
        integer: "integer",
        longtext: "string",
        shorttext: "string",
        sql: "string",
        json: "json",
    };
    const components = {
        longtext: "textarea",
        sql: "editor-sql",
    };
    return {
        slug: opts.slug || makeSlug(name),
        name,
        type: types[type],
        component: components[type],
        constraints: {
            optional: opts.required === false ? true : false,
            options,
            regex: (_b = opts.regex) === null || _b === void 0 ? void 0 : _b.source,
        },
        desc: opts.description ? dedent(opts.description) : undefined,
        default: serializeParamValue(opts.default, opts.multi),
    };
};
