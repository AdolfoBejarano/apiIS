"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.query = void 0;
const ts_dedent_1 = require("ts-dedent");
const builtins_1 = require("./builtins");
const execute_1 = require("../execute");
/**
 * A SQL query either returns a list of rows, where each row is typed by `TRow`
 * or it is a DDL query without a `RETURNING` clause. To type the latter case,
 * provide `QueryExecOutput` as `TRow`. For example:
 *
 * query<QueryExecOutput>(...): BuiltInRun<..., {Q1: {rows_affected: number}}>
 * query<{name: string}>(...): BuiltInRun<..., {Q1: {name: string}[]}>
 * @param sqlResource The alias or slug of the DB resource to query
 * @param query The SQL query to execute. Can be DDL or DML and can include multiple queries separated by semicolons. Multiple queries will be executed together as a transaction.
 * @param opts Additional configuration options
 */
// Uses a function so we can overload its signature.
// eslint-disable-next-line prefer-arrow/prefer-arrow-functions
async function query(sqlResource, query, opts = {}) {
    let { args, transactionMode, client } = opts;
    transactionMode = transactionMode !== null && transactionMode !== void 0 ? transactionMode : "auto";
    return (0, execute_1.executeWithResources)("airplane:sql_query", { query: (0, ts_dedent_1.dedent)(query), queryArgs: args, transactionMode }, { db: (0, builtins_1.convertResourceAliasToID)(sqlResource) }, client);
}
exports.query = query;
