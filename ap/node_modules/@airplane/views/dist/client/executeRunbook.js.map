{"version":3,"file":"executeRunbook.js","sources":["../../src/client/executeRunbook.ts"],"sourcesContent":["import { executeRunbookBackground } from \"airplane\";\nimport { SessionTerminationError } from \"airplane\";\nimport { getSession } from \"airplane/api\";\nimport type { ParamValues } from \"airplane/api\";\nimport hash from \"object-hash\";\n\nimport { isGenericExecuteError } from \"client/status\";\nimport type { ExecuteError } from \"components/query\";\nimport { MISSING_EXECUTE_PERMISSIONS_ERROR_PREFIX } from \"errors/formatErrors\";\nimport { sendViewMessage } from \"message/sendViewMessage\";\n\nimport { getExecuteOptions } from \"./env\";\nimport { DefaultParams } from \"./executeTask\";\n\nexport type ExecuteRunbookSuccess = {\n  sessionID: string;\n};\nexport type ExecuteRunbookError = {\n  error: ExecuteError;\n  sessionID?: string;\n};\nexport type ExecuteRunbookResult = ExecuteRunbookSuccess | ExecuteRunbookError;\n\nexport const executeRunbook = async <\n  TParams extends ParamValues | undefined = ParamValues,\n>(\n  slug: string,\n  executeType: \"query\" | \"mutation\" = \"mutation\",\n  params?: TParams,\n): Promise<ExecuteRunbookResult> => {\n  try {\n    const executeOptions = getExecuteOptions(executeType);\n    const sessionID = await executeRunbookBackground(\n      slug,\n      params,\n      executeOptions,\n    );\n\n    sendViewMessage({\n      type: \"start_session\",\n      sessionID,\n    });\n\n    const checkSession = async () => {\n      const session = await getSession<DefaultParams>(\n        sessionID,\n        executeOptions,\n      );\n      if (session.status === \"Failed\" || session.status === \"Cancelled\") {\n        throw new SessionTerminationError(session);\n      }\n      if (session.status !== \"Succeeded\") {\n        return null;\n      }\n      return {\n        sessionID: session.id,\n      };\n    };\n    // Poll until the session terminates:\n    const output = await new Promise<ExecuteRunbookResult>(\n      (resolve, reject) => {\n        const fnw = async () => {\n          try {\n            const out = await checkSession();\n            if (out !== null) {\n              return resolve(out);\n            }\n          } catch (err) {\n            return reject(err);\n          }\n\n          setTimeout(fnw, 500);\n        };\n        fnw();\n      },\n    );\n    return output;\n  } catch (e) {\n    if (isSessionTerminationError(e)) {\n      return {\n        error: { message: e.message, type: \"FAILED\" },\n        sessionID: e.session.id,\n      };\n    }\n    if (isGenericExecuteError(e)) {\n      if (e.statusCode === 403) {\n        return {\n          error: {\n            message: `${MISSING_EXECUTE_PERMISSIONS_ERROR_PREFIX} ${slug}`,\n            type: \"AIRPLANE_INTERNAL\",\n          },\n        };\n      } else if (e.statusCode >= 400 && e.statusCode < 500) {\n        sendViewMessage({\n          type: \"console\",\n          messageType: \"error\",\n          message: e.message,\n          runbookSlug: slug,\n          hash: hash(e),\n          time: Date.now(),\n        });\n        return {\n          error: {\n            message: e.message,\n            type: \"CLIENT_ERROR\",\n          },\n        };\n      } else {\n        sendViewMessage({\n          type: \"console\",\n          messageType: \"error\",\n          message: e.message,\n          runbookSlug: slug,\n          hash: hash(e),\n          time: Date.now(),\n        });\n        return {\n          error: { message: e.message, type: \"AIRPLANE_INTERNAL\" },\n        };\n      }\n    } else {\n      const message = \"An error occured\";\n      sendViewMessage({\n        type: \"console\",\n        messageType: \"error\",\n        message,\n        runbookSlug: slug,\n        hash: hash(message),\n        time: Date.now(),\n      });\n      return {\n        error: { message, type: \"AIRPLANE_INTERNAL\" },\n      };\n    }\n  }\n};\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst isSessionTerminationError = (x: any): x is SessionTerminationError => {\n  return typeof x.message === \"string\" && \"session\" in x;\n};\n\nexport function isExecuteRunbookError(\n  value: ExecuteRunbookResult,\n): value is ExecuteRunbookError {\n  return !!(value as ExecuteRunbookError).error;\n}\n"],"names":["executeRunbook","slug","executeType","params","executeOptions","getExecuteOptions","sessionID","executeRunbookBackground","type","checkSession","session","getSession","status","SessionTerminationError","id","output","Promise","resolve","reject","fnw","out","err","setTimeout","e","isSessionTerminationError","error","message","isGenericExecuteError","statusCode","MISSING_EXECUTE_PERMISSIONS_ERROR_PREFIX","messageType","runbookSlug","hash","time","Date","now","x","isExecuteRunbookError","value"],"mappings":"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"}